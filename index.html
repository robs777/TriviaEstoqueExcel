<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Controle de Estoque Cloud</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 30px auto; background: #f0f2f5; padding: 20px; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 10px; margin-bottom: 20px; }
        input, button { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #007bff; color: white; }
        .qtd-badge { font-weight: bold; padding: 5px 10px; border-radius: 20px; background: #e9ecef; }
        .btn-add { background: #28a745; color: white; border: none; }
        .btn-out { background: #dc3545; color: white; border: none; }
        .btn-del { background: #6c757d; color: white; border: none; font-size: 11px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“¦ Novo Equipamento</h2>
    <form id="formEstoque" class="form-group">
        <input type="text" id="nome" placeholder="Nome do Equipamento" required>
        <input type="text" id="descricao" placeholder="DescriÃ§Ã£o/Marca" required>
        <input type="number" id="qtdInicial" placeholder="Qtd Inicial" value="0">
        <button type="submit" class="btn-add">Cadastrar</button>
    </form>

    <hr>

    <h2>ðŸ“Š InventÃ¡rio em Tempo Real</h2>
    <table id="tabelaEstoque">
        <thead>
            <tr>
                <th>Equipamento</th>
                <th>DescriÃ§Ã£o</th>
                <th>Qtd Atual</th>
                <th>MovimentaÃ§Ã£o</th>
                <th>AÃ§Ãµes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyVooUtYkSw9FKHmK3_HKbF36aDdY5S9BUNgBf3cp37-GRRAjgwTQ2rjNDQqRY7sHSEJA/exec";

    // 1. CARREGAR DADOS (SincronizaÃ§Ã£o Inicial)
async function carregarEstoque() {
    const res = await fetch(API_URL);
    const dados = await res.json();
    renderizarTabela(dados);
}

function renderizarTabela(dados) {
    const tbody = document.querySelector("#tabelaEstoque tbody");
    tbody.innerHTML = "";
    dados.forEach(item => {
        tbody.innerHTML += `
            <tr id="row-${item.ID}">
                <td><strong>${item.NomeEquipamento}</strong></td>
                <td>${item.Descricao}</td>
                <td><span class="qtd-badge">${item.QTDEstoque}</span></td>
                <td>
                    <button class="btn-add" onclick="alterarEstoque('${item.ID}', 1)">+1</button>
                    <button class="btn-out" onclick="alterarEstoque('${item.ID}', -1)">-1</button>
                </td>
                <td><button class="btn-del" onclick="deletar('${item.ID}')">Excluir</button></td>
            </tr>`;
    });
}

// 2. ALTERAR ESTOQUE (MÃ“DULO INSTANTÃ‚NEO)
function alterarEstoque(id, valor) {
    // Localiza os elementos na tela
    const linha = document.getElementById(`row-${id}`);
    const badge = linha.querySelector('.qtd-badge');
    
    // AtualizaÃ§Ã£o Otimista (Visual)
    let qtdAtual = parseInt(badge.innerText);
    let novaQtd = Math.max(0, qtdAtual + valor);
    badge.innerText = novaQtd; 

    // Envia para o Google em segundo plano (sem travar o usuÃ¡rio)
    fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "update_stock", id: id, movimentacao: valor })
    }).catch(err => {
        console.error("Erro na sincronizaÃ§Ã£o:", err);
        alert("Erro ao salvar! Sincronizando dados reais...");
        carregarEstoque(); // Se der erro, volta ao valor real da planilha
    });
}

// 3. CADASTRAR NOVO (Aqui mantemos o await para limpar o form no tempo certo)
document.getElementById("formEstoque").addEventListener("submit", async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button');
    btn.innerText = "Enviando...";
    btn.disabled = true;

    const nome = document.getElementById("nome").value;
    const descricao = document.getElementById("descricao").value;
    const qtd = document.getElementById("qtdInicial").value;

    await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "create", nome, descricao, qtd })
    });

    document.getElementById("formEstoque").reset();
    btn.innerText = "Cadastrar";
    btn.disabled = false;
    carregarEstoque();
});

// 4. DELETAR (Otimista)
function deletar(id) {
    if(!confirm("Remover item?")) return;
    
    // Remove da tela na hora
    document.getElementById(`row-${id}`).style.opacity = "0.3";
    
    fetch(API_URL, { 
        method: "POST", 
        body: JSON.stringify({ action: "delete", id }) 
    }).then(() => {
        document.getElementById(`row-${id}`).remove();
    });
}

carregarEstoque();
</script>

</body>
</html>